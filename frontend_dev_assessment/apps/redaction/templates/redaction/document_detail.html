{% extends "redaction/base.html" %} {% block title %}{{ document.title }} - PDF
Redaction Tool{% endblock %} {% block content %}
<div class="flex flex-col lg:flex-row gap-6">
	<!-- Left Panel: PDF Viewer -->
	<div id="pdf-signals" class="flex-1 bg-white rounded-lg shadow-md p-6">
		<div class="mb-4 flex items-center justify-between">
			<h2 class="text-xl font-bold text-gray-800">{{ document.title }}</h2>
			<a
				href="{% url 'redaction:document_list' %}"
				class="text-blue-600 hover:text-blue-800 text-sm"
			>
				&larr; Back to Documents
			</a>
		</div>

		<!-- PDF Viewer Container -->
		<div
			id="pdf-viewer-container"
			class="border border-gray-300 rounded-lg overflow-auto bg-gray-50"
			style="min-height: 600px"
			data-signals="{type: 'text', coordinates: {x: 0, y: 0, width: 0, height: 0, page: 1}}"
			>
			{% comment %} data-on:paginationchanged="evt.detail.source === 'document-detail-pagination' ? $coordinates.page = evt.detail.page  : ''" {% endcomment %}
			{% comment %} data-effect="renderPage($coordinates.page)" {% endcomment %}
			<!-- Mode Selector -->
			<div
				id="modeSelector"
				class="inline-flex rounded-2xl shadow-sm bg-white border border-gray-300 overflow-hidden"
			>
				<!-- Text Selection Mode -->
				<button
					class="px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					data-on:click="$type = 'text'"
					data-class="{'bg-blue-600 text-white shadow-inner': $type === 'text'}"
				>
					‚úçÔ∏è <span>Text Selection</span>
				</button>
				<button
					class="px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					data-on:click="$type = 'area'"
					data-class="{'bg-blue-600 text-white shadow-inner': $type === 'area'}"
				>
					üü© <span>Area Drawing</span>
				</button>
			</div>
			<div class="p-4"
				data-on-signal-patch="renderPage(patch.coordinates.page)"
				data-on-signal-patch-filter="{include: /^coordinates\.page$/, exclude: /^(_fetching|type)$/}"
				>
				<!-- PDF Viewer Container -->
				{% include "redaction/pdf_loader.html" %}
				<div id="pdf-container" class="pdfViewer relative">
					<canvas id="pdf" class="mx-auto border border-gray-300"></canvas>
					<div
						id="text-layer"
						class="textLayer"
						data-on:mouseup="(() => {
							const sel = handleTextSelection(evt);
							if (!sel) return;
							$coordinates.x = sel.x;
							$coordinates.y = sel.y;
							$coordinates.width = sel.width;
							$coordinates.height = sel.height;
						})()"
						data-on-signal-patch="($coordinates.width && $coordinates.height) && @post('/document/{{ document.pk }}/redactions/create/')"
						data-on-signal-patch-filter="{exclude: /^(coordinates.page|_fetching|type)$/ }"
					></div>
				</div>

				{% include "redaction/pagination.html" %}
				<script type="module">
					let pdf = null;
					let pageRendering = false;
					let pageNumPending = null;
					let redactionsData = [];

					const pdfUrl = "{{ document.file.url }}";

					const canvas = document.getElementById("pdf");
					const ctx = canvas.getContext("2d");
					const textLayer = document.getElementById("text-layer");
					const buttons = document.querySelectorAll(".mode-btn");
					const loader = document.getElementById("pdf-loader");
					const pdfContainer = document.getElementById("pdf-container");

					// Setup of PDF.js worker
					initPDF();
					
					function handleTextSelection() {
						const selection = globalThis.getSelection();
						if (!selection.rangeCount || selection.isCollapsed) {
							return null;
						}

						const range = selection.getRangeAt(0);
						const rects = range.getClientRects();
						// Use the textLayer as the reference for coordinates
						const textLayer = document.getElementById('text-layer');
						const containerRect = textLayer.getBoundingClientRect();

						// If no rects, return null
						if (!rects.length) return null;

						// Find the bounding box that contains all rects (across lines)
						let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
						for (const rect of rects) {
							const x = rect.left - containerRect.left;
							const y = rect.top - containerRect.top;
							const right = rect.right - containerRect.left;
							const bottom = rect.bottom - containerRect.top;
							if (x < minX) minX = x;
							if (y < minY) minY = y;
							if (right > maxX) maxX = right;
							if (bottom > maxY) maxY = bottom;
						}
						const width = maxX - minX;
						const height = maxY - minY;

						// Only return if selection is visible and has area
						if (width > 0 && height > 0) {
							return { x: minX, y: minY, width, height };
						}
						//return null;
					}

					// Initialize PDF
					function initPDF() {
						if (typeof pdfjsLib === "undefined") {
							loader.innerHTML = "<span class='text-red-600'>PDF.js library not loaded.</span>";
							return;
						}
						loader.style.display = "block";
						canvas.style.display = "none";

						pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.mjs";

						const loadingTask = pdfjsLib.getDocument(pdfUrl);
						loadingTask.promise.then((loadedPdf) => {
							pdf = loadedPdf;
							document.getElementById("totalPages").dispatchEvent(
								new CustomEvent("totalpagesevent", {
									detail: {
										totalPages: pdf.numPages,
									},
								})
							);
							// Load initial page
							renderPage(1);
						}).catch(function(error) {
							console.error("Error loading PDF:", error);
							document.getElementById("pdf-loader").innerHTML = '<span class="text-red-600">Failed to load PDF</span>';
						});
					}

					// Initialize update mode
					function renderPage(pageNum) {
						pdf.getPage(pageNum).then((page) => {
							const viewport = page.getViewport({ scale: 1.5 });
							pdfContainer.style.setProperty('--scale-factor', viewport.scale);
							canvas.height = viewport.height;
							canvas.width = viewport.width;
							const renderContext = {
								canvasContext: ctx,
								viewport: viewport,
							};

							page.render(renderContext).promise.then(() => {
								page.getTextContent().then((textContent) => {
									pdfjsLib.renderTextLayer({
										textContentSource: textContent,
										viewport,
										container: textLayer,
										textDivs: []
									});
									
									loader.style.display = "none";
									canvas.style.display = "block";
								});
							});
						});
					}

					function getSelectionRects() {
						const selection = globalThis.getSelection();
						if (!selection.rangeCount || selection.isCollapsed) {
							return [];
						}

						const range = selection.getRangeAt(0);
						const rects = range.getClientRects();
						const viewerRect = document.getElementById('viewer').getBoundingClientRect();
						
						const normalizedRects = [];
						for (const element of rects) {
							const rect = element;
							normalizedRects.push({
								x: rect.left - viewerRect.left,
								y: rect.top - viewerRect.top,
								width: rect.width,
								height: rect.height
							});
						}
						
						return normalizedRects;
					}
					globalThis.handleTextSelection = handleTextSelection;
					globalThis.renderPage = renderPage;


					// function handleTextSelection(e) {
					// Check if we're in text mode
					// const store = globalThis.store || {};
					// if (store.mode !== "text") return;
					// redactionMode === "text"

					// console.log(e);
					// console.log(globalThis.getSelection());

					// 	const selection = globalThis.getSelection();
					// 	if (!selection.toString().trim()) return;

					// 	const range = selection.getRangeAt(0);
					// 	const rect = range.getBoundingClientRect();
					// 	const containerRect = textLayer.getBoundingClientRect();

					// 	const x = rect.left - containerRect.left;
					// 	const y = rect.top - containerRect.top;
					// 	const width = rect.width;
					// 	const height = rect.height;

					// 	// if (width > 0 && height > 0) {
					// 	console.log("text >> ", { x, y, width, height });
					// 	// 	// selection.removeAllRanges();
					// 	// }
					// }
					// });
				</script>
				<!-- <div class="text-center py-12 text-gray-500">
					<svg
						class="mx-auto h-16 w-16 text-gray-400 mb-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
						/>
					</svg>
					<p class="text-lg font-medium">PDF Viewer Placeholder</p>
					<p class="text-sm mt-2">Implement PDF.js viewer here to display:</p>
					<p class="text-sm font-mono mt-1">{{ document.file.url }}</p>
					<div
						class="mt-4 text-left max-w-md mx-auto bg-yellow-50 border border-yellow-200 rounded p-4"
					>
						<p class="font-semibold text-yellow-900 mb-2">
							Implementation Steps:
						</p>
						<ol
							class="list-decimal list-inside text-sm text-yellow-800 space-y-1"
						>
							<li>Load PDF.js library (already included in base.html)</li>
							<li>Fetch and render PDF from the URL above</li>
							<li>Add mouse event handlers for selection/drawing</li>
							<li>
								Send redaction data to:
								<code class="bg-yellow-100 px-1 rounded"
									>{% url 'redaction:redaction_create' document.pk %}</code
								>
							</li>
							<li>Use DataStar to update the redactions list dynamically</li>
						</ol>
					</div>
				</div> -->
			</div>
		</div>

		<!-- Action Buttons -->
		<div class="mt-4">
			<a
				href="{% url 'redaction:document_download' document.pk %}"
				class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition-colors"
			>
				üì• Download Redacted PDF
			</a>
		</div>
	</div>

	<!-- Right Panel: Redactions List -->
	<div class="w-full lg:w-80 bg-white rounded-lg shadow-md p-6">
		<h3 class="text-lg font-bold text-gray-800 mb-4">Redactions</h3>

		<div class="text-sm text-gray-600 mb-4">
			<p>
				Total:
				<span id="redaction-count" class="font-semibold"
					>{{ redactions.count }}</span
				>
			</p>
		</div>
		{% include "redaction/redaction_list.html" %}
	</div>
</div>

<!-- Help Section -->
<div class="mt-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
	<h4 class="font-semibold text-purple-900 mb-2">
		üéØ Implementation Guidelines
	</h4>
	<div class="text-sm text-purple-800 space-y-2">
		<p><strong>DataStar Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a href="https://data-star.dev" target="_blank" class="underline"
					>DataStar Documentation</a
				>
			</li>
			<li>
				<a
					href="https://data-star.dev/examples"
					target="_blank"
					class="underline"
					>DataStar Examples</a
				>
			</li>
		</ul>
		<p class="mt-2"><strong>PDF.js Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/"
					target="_blank"
					class="underline"
					>PDF.js Documentation</a
				>
			</li>
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/examples/"
					target="_blank"
					class="underline"
					>PDF.js Examples</a
				>
			</li>
		</ul>
	</div>
</div>
{% endblock %}
