{% extends "redaction/base.html" %} {% block title %}{{ document.title }} - PDF
Redaction Tool{% endblock %} {% block content %}
<div class="flex flex-col lg:flex-row gap-6">
	<!-- Left Panel: PDF Viewer -->
	<div id="pdf-signals" class="flex-1 bg-white rounded-lg shadow-md p-6">
		<div class="mb-4 flex items-center justify-between">
			<h2 class="text-xl font-bold text-gray-800">{{ document.title }}</h2>
			<a
				href="{% url 'redaction:document_list' %}"
				class="text-blue-600 hover:text-blue-800 text-sm"
			>
				&larr; Back to Documents
			</a>
		</div>

		<!-- PDF Viewer Container -->
		<div
			id="pdf-viewer-container"
			class="border border-gray-300 rounded-lg overflow-auto bg-gray-50"
			style="min-height: 600px"
			data-signals="{type: 'text', coordinates: {x: 0, y: 0, width: 0, height: 0, page: 1}}"
		>
			{% comment %} data-on:paginationchanged="evt.detail.source === 'document-detail-pagination' ? $coordinates.page = evt.detail.page  : ''" {% endcomment %}
			{% comment %} data-effect="renderPage($coordinates.page)" {% endcomment %}
			<!-- Mode Selector -->
			<div
				id="modeSelector"
				class="inline-flex rounded-2xl shadow-sm bg-white border border-gray-300 overflow-hidden"
			>
				<!-- Text Selection Mode -->
				<button
					class="px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					data-on:click="$type = 'text'"
					data-class="{'bg-blue-600 text-white shadow-inner': $type === 'text'}"
				>
					‚úçÔ∏è <span>Text Selection</span>
				</button>
				<button
					class="px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					data-on:click="$type = 'area'"
					data-class="{'bg-blue-600 text-white shadow-inner': $type === 'area'}"
				>
					üü© <span>Area Drawing</span>
				</button>
			</div>
			<div class="p-4"
				data-on-signal-patch="renderPage(patch.coordinates.page)"
				data-on-signal-patch-filter="{include: /^coordinates\.page$/, exclude: /^(_fetching|type)$/}"
				>
				<!-- PDF Viewer Container -->
				{% include "redaction/pdf_loader.html" %}
				<div id="pdf-container" class="pdfViewer relative">
					<canvas id="pdf" class="mx-auto border border-gray-300"></canvas>
					<div class="annotationLayer">
						{% for redaction in redactions %}
							{% include "redaction/redaction_overlay_block.html" %}
						{% endfor %}
					</div>
					<div id="text-layer"
						class="textLayer"
						data-show="$type === 'text'"
						data-on:mouseup="
							if (evt.target.matches('span') && handleTextSelection(evt)?.length) {
								for (const sel of handleTextSelection(evt)) {
									setTimeout(() => {
										if (!sel) return;
										$coordinates.x = sel.x;
										$coordinates.y = sel.y;
										$coordinates.width = sel.width;
										$coordinates.height = sel.height;
										@post('/document/{{ document.pk }}/redactions/create/');
									}, 100);
								}
							}
						"
					></div>
					<canvas class="absolute top-[0px] left-[0px]" data-show="$type === 'area'" id="drawing-canvas"></canvas>
				</div>

				{% include "redaction/pagination.html" %}
				<script type="module">
					let pdf = null;
					let pageRendering = false;
					let pageNumPending = null;
					let viewport = null;
					const VIEWPORT_SCALE = 1.5;

					const pdfUrl = "{{ document.file.url }}";

					const canvas = document.getElementById("pdf");
					const ctx = canvas.getContext("2d");
					const textLayer = document.getElementById("text-layer");
					const buttons = document.querySelectorAll(".mode-btn");
					const loader = document.getElementById("pdf-loader");
					const pdfContainer = document.getElementById("pdf-container");
					const drawingCanvas = document.getElementById("drawing-canvas");
					
					pdfContainer.style.setProperty('--scale-factor', VIEWPORT_SCALE);

					// Setup of PDF.js worker
					initPDF();

					// Initialize PDF
					function initPDF() {
						if (typeof pdfjsLib === "undefined") {
							loader.innerHTML = "<span class='text-red-600'>PDF.js library not loaded.</span>";
							return;
						}
						loader.style.display = "block";
						canvas.style.display = "none";

						pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.mjs";

						const loadingTask = pdfjsLib.getDocument(pdfUrl);
						loadingTask.promise.then((loadedPdf) => {
							pdf = loadedPdf;
							document.getElementById("totalPages").dispatchEvent(
								new CustomEvent("totalpagesevent", {
									detail: {
										totalPages: pdf.numPages,
									},
								})
							);
							// Load initial page
							renderPage(1);
						}).catch(function(error) {
							console.error("Error loading PDF:", error);
							document.getElementById("pdf-loader").innerHTML = '<span class="text-red-600">Failed to load PDF</span>';
						});
					}

					// Initialize update mode
					function renderPage(pageNum) {
						pdf.getPage(pageNum).then((page) => {
							viewport = page.getViewport({ scale: VIEWPORT_SCALE });
							canvas.height = viewport.height;
							canvas.width = viewport.width;
							drawingCanvas.height = viewport.height;
							drawingCanvas.width = viewport.width;
							const renderContext = {
								canvasContext: ctx,
								viewport: viewport,
							};

							page.render(renderContext).promise.then(() => {
								page.getTextContent().then((textContent) => {
									// Clear existing text layer
									textLayer.innerHTML = "";

									// Group text content items into lines as textContent can sometimes contain fragmented pieces
									textContent.items = groupTextContentItems(textContent.items);

									pdfjsLib.renderTextLayer({
										textContentSource: textContent,
										viewport,
										container: textLayer,
										textDivs: []
									});

									loader.style.display = "none";
									canvas.style.display = "block";
								});
							});

						});
					}

					function handleTextSelection() {
						const selection = globalThis.getSelection();

						if (selection.rangeCount > 0 && !selection.isCollapsed) {
							const range = selection.getRangeAt(0);
							const selectedText = selection.toString();
							
							// Get the actual selection rectangles
							const rects = range.getClientRects();
							
							if (rects.length > 0) {
								const textLayerRect = textLayer.getBoundingClientRect();
								
								// Convert each rectangle individually
								const redactionBoxes = Array.from(rects)
									.filter(rect => rect.width > 0 && rect.height > 0)
									.map(rect => {
										// Screen coordinates relative to text layer
										const relativeX = rect.left - textLayerRect.left;
										const relativeY = rect.top - textLayerRect.top;
										
										// Scaled box (for drawing on screen)
										const scaledBox = {
											x: relativeX,
											y: relativeY,
											width: rect.width,
											height: rect.height
										};
										
										// Unscaled box (for backend)
										const unscaledBox = {
											x: relativeX / VIEWPORT_SCALE,
											y: relativeY / VIEWPORT_SCALE,
											width: rect.width / VIEWPORT_SCALE,
											height: rect.height / VIEWPORT_SCALE
										};
										
										return {
											scaled: scaledBox,
											unscaled: unscaledBox
										};
									});
								
								return redactionBoxes.map(box => box.unscaled);
							}
							return [];
						}
						return [];
					}

					function drawSavedRedactionsBox(id, x, y, width, height) {
						const redactionDiv = document.createElement('div');
						redactionDiv.setAttribute('id', `redaction-${id}`);
						redactionDiv.style.position = 'absolute';
						redactionDiv.style.left = x + 'px';
						redactionDiv.style.top = y + 'px';
						redactionDiv.style.width = width + 'px';
						redactionDiv.style.height = height + 'px';
						redactionDiv.style.backgroundColor = 'black';
						redactionDiv.style.zIndex = '10';
						
						pdfContainer.appendChild(redactionDiv);
					}

					function groupTextContentItems(items) {
						const groupedItems = [];
						let buffer = [];
						let lastY = null;
						for (const item of items) {
							buffer.push(item);
							if (item.hasEOL) {
								// Join all buffered items into one line
								const joinedStr = buffer.map(i => i.str).join('');
								const left = item.str === '' ? Math.max(...buffer.map(i => i.transform[4])) : Math.min(...buffer.map(i => i.transform[4]));
								const top = item.str === '' ? Math.max(...buffer.map(i => i.transform[5])) : Math.min(...buffer.map(i => i.transform[5]));
								const right = Math.max(...buffer.map(i => i.transform[4] + i.width));
								const height = Math.max(...buffer.map(i => i.height));
								const width = right - left;
								const newItem = {
									...buffer[0],
									str: joinedStr,
									hasEOL: true,
									width: width,
									height: height,
									transform: [...buffer[0].transform],
								};
								newItem.transform[4] = left;
								newItem.transform[5] = top;
								groupedItems.push(newItem);
								buffer = [];
							}
						}
						// If any items left in buffer (no EOL at end), join them too
						if (buffer.length) {
							const joinedStr = buffer.map(i => i.str).join('');
							const left = Math.min(...buffer.map(i => i.transform[4]));
							const top = Math.min(...buffer.map(i => i.transform[5]));
							const right = Math.max(...buffer.map(i => i.transform[4] + i.width));
							const height = Math.max(...buffer.map(i => i.height));
							const width = right - left;
							const newItem = {
								...buffer[0],
								str: joinedStr,
								hasEOL: false,
								width: width,
								height: height,
								transform: [...buffer[0].transform],
							};
							newItem.transform[4] = left;
							newItem.transform[5] = top;
							groupedItems.push(newItem);
						}
						return groupedItems;
					}

					globalThis.handleTextSelection = handleTextSelection;
					globalThis.renderPage = renderPage;
				</script>
			</div>
		</div>

		<!-- Action Buttons -->
		<div class="mt-4">
			<a
				href="{% url 'redaction:document_download' document.pk %}"
				class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition-colors"
			>
				üì• Download Redacted PDF
			</a>
		</div>
	</div>

	<!-- Right Panel: Redactions List -->
	<div class="w-full lg:w-80 bg-white rounded-lg shadow-md p-6">
		<h3 class="text-lg font-bold text-gray-800 mb-4">Redactions</h3>

		<div class="text-sm text-gray-600 mb-4">
			<p>
				Total:
				<span id="redaction-count" class="font-semibold"
					>{{ redactions.count }}</span
				>
			</p>
		</div>
		{% include "redaction/redaction_list.html" %}
	</div>
</div>

<!-- Help Section -->
<div class="mt-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
	<h4 class="font-semibold text-purple-900 mb-2">
		üéØ Implementation Guidelines
	</h4>
	<div class="text-sm text-purple-800 space-y-2">
		<p><strong>DataStar Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a href="https://data-star.dev" target="_blank" class="underline"
					>DataStar Documentation</a
				>
			</li>
			<li>
				<a
					href="https://data-star.dev/examples"
					target="_blank"
					class="underline"
					>DataStar Examples</a
				>
			</li>
		</ul>
		<p class="mt-2"><strong>PDF.js Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/"
					target="_blank"
					class="underline"
					>PDF.js Documentation</a
				>
			</li>
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/examples/"
					target="_blank"
					class="underline"
					>PDF.js Examples</a
				>
			</li>
		</ul>
	</div>
</div>
{% endblock %}
