{% extends "redaction/base.html" %} {% block title %}{{ document.title }} - PDF
Redaction Tool{% endblock %} {% block content %}
<div class="flex flex-col lg:flex-row gap-6">
	<!-- Left Panel: PDF Viewer -->
	<div class="flex-1 bg-white rounded-lg shadow-md p-6">
		<div class="mb-4 flex items-center justify-between">
			<h2 class="text-xl font-bold text-gray-800">{{ document.title }}</h2>
			<a
				href="{% url 'redaction:document_list' %}"
				class="text-blue-600 hover:text-blue-800 text-sm"
			>
				&larr; Back to Documents
			</a>
		</div>

		<!-- PDF Viewer Container -->
		<div
			class="border border-gray-300 rounded-lg overflow-auto bg-gray-50"
			style="min-height: 600px"
		>
			<!-- TODO for candidates: Implement PDF.js viewer here -->
			<div id="pdf-container" class="p-4">
				<div
					id="modeSelector"
					class="inline-flex rounded-2xl shadow-sm bg-white border border-gray-300 overflow-hidden"
				>
					<!-- Text Selection Mode -->
					<button
						data-mode="text"
						class="mode-btn px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					>
						‚úçÔ∏è <span>Text Selection</span>
					</button>

					<!-- Area Drawing Mode -->
					<button
						data-mode="area"
						class="mode-btn px-5 py-2 flex items-center gap-2 text-sm font-medium transition-all focus:outline-none"
					>
						üü© <span>Area Drawing</span>
					</button>
				</div>
				{% include "redaction/pdf_loader.html" %}
				<canvas id="pdf" class="mx-auto border border-gray-300"></canvas>
				<div id="text-layer" class="textLayer"></div>

				<!-- opacity-20  -->
				<canvas
					id="redaction-layer"
					class="absolute pointer-events-none"
				></canvas>

				{% include "redaction/pagination.html" with page_count=1 page_num=1 %}
				<script>
					document.addEventListener("DOMContentLoaded", async () => {
						// PDF.js is assumed to be loaded globally as pdfjsLib
						console.log(globalThis);

						console.log("{{ document.file.url }}");

						let pdf = null;
						let redactionMode = "text";
						let redactionBoxes = [];
						let isDrawing = false;
						let currentPage = 1;

						const buttons = document.querySelectorAll(".mode-btn");
						const loader = document.getElementById("pdf-loader");
						const canvas = document.getElementById("pdf");
						const textLayer = document.getElementById("text-layer");
						const redactionLayer = document.getElementById("redaction-layer");
						const redactionCtx = redactionLayer.getContext("2d");
						const url = "{{ document.file.url }}";
						const ctx = canvas.getContext("2d");

						loader.style.display = "flex";
						canvas.style.display = "none";

						// Setup of PDF.js worker
						if (typeof pdfjsLib === "undefined") {
							loader.innerHTML =
								"<span class='text-red-600'>PDF.js library not loaded.</span>";
							return;
						}
						pdfjsLib.GlobalWorkerOptions.workerSrc =
							"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.mjs";

						// Fetch Document from URL and render first page
						try {
							pdf = await pdfjsLib.getDocument(url).promise;
							document.getElementById("pagination").dataset.pageCount =
								pdf.numPages;
							document.getElementById("page_count").textContent = pdf.numPages;
							renderPage(1);
						} catch (e) {
							loader.innerHTML =
								"<span class='text-red-600'>Failed to load PDF.</span>";
							console.error(e);
						}

						// Start listening to event from pagination controls
						globalThis.addEventListener("paginationChanged", (e) => {
							if (e.detail.source !== "document-detail-pagination") {
								return;
							}
							currentPage = e.detail.page;
							renderPage(currentPage);
						});

						// Initialize update mode
						updateMode(redactionMode);

						async function renderPage(pageNum) {
							const page = await pdf.getPage(pageNum);

							const viewport = page.getViewport({ scale: 1.5 });
							canvas.height = viewport.height;
							canvas.width = viewport.width;
							redactionLayer.height = viewport.height;
							redactionLayer.width = viewport.width;
							redactionLayer.style.left = canvas.offsetLeft + "px";
							redactionLayer.style.top = canvas.offsetTop + "px";
							const renderContext = {
								canvasContext: ctx,
								viewport: viewport,
							};
							console.log("page ", page);

							await page.render(renderContext).promise;

							const textContent = await page.getTextContent();

							textLayer.style.left = canvas.offsetLeft + "px";
							textLayer.style.top = canvas.offsetTop + "px";
							textLayer.style.height = canvas.offsetHeight + "px";
							textLayer.style.width = canvas.offsetWidth + "px";

							pdfjsLib.renderTextLayer({
								textContentSource: textContent,
								textContent: textContent,
								container: textLayer,
								viewport: viewport,
								textDivs: [],
							});

							// pdfjsLib.renderTextLayer({
							// 	textContentSource: textContent,
							// 	container: document.getElementById("text-layer"),
							// 	viewport: viewport,
							// 	textDivs: [],
							// });

							// for (const item of textContent.items) {
							// 	const tx = pdfjsLib.Util.transform(
							// 		viewport.transform,
							// 		item.transform
							// 	);

							// 	const span = document.createElement("span");
							// 	span.textContent = item.str;
							// 	span.style.left = tx[4] + "px";
							// 	span.style.top = tx[5] - item.height + "px";
							// 	span.style.fontSize =
							// 		Math.sqrt(tx[0] * tx[0] + tx[1] * tx[1]) + "px";
							// 	span.style.fontFamily = item.fontName;
							// 	textLayer.appendChild(span);
							// }
							loader.style.display = "none";
							canvas.style.display = "block";
						}

						function updateMode(mode) {
							redactionMode = mode;

							buttons.forEach((btn) => {
								if (btn.dataset.mode === mode) {
									btn.classList.add(
										"bg-blue-600",
										"text-white",
										"shadow-inner"
									);
									btn.classList.remove("bg-white", "text-gray-800");
								} else {
									btn.classList.remove(
										"bg-blue-600",
										"text-white",
										"shadow-inner",
										"scale-105"
									);
									btn.classList.add("bg-white", "text-gray-800");
								}
							});

							console.log(`Current mode: ${redactionMode}`);
						}

						for (const btn of buttons) {
							btn.addEventListener("click", () => updateMode(btn.dataset.mode));
						}
					});
				</script>
				<!-- <div class="text-center py-12 text-gray-500">
					<svg
						class="mx-auto h-16 w-16 text-gray-400 mb-4"
						fill="none"
						stroke="currentColor"
						viewBox="0 0 24 24"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"
						/>
					</svg>
					<p class="text-lg font-medium">PDF Viewer Placeholder</p>
					<p class="text-sm mt-2">Implement PDF.js viewer here to display:</p>
					<p class="text-sm font-mono mt-1">{{ document.file.url }}</p>
					<div
						class="mt-4 text-left max-w-md mx-auto bg-yellow-50 border border-yellow-200 rounded p-4"
					>
						<p class="font-semibold text-yellow-900 mb-2">
							Implementation Steps:
						</p>
						<ol
							class="list-decimal list-inside text-sm text-yellow-800 space-y-1"
						>
							<li>Load PDF.js library (already included in base.html)</li>
							<li>Fetch and render PDF from the URL above</li>
							<li>Add mouse event handlers for selection/drawing</li>
							<li>
								Send redaction data to:
								<code class="bg-yellow-100 px-1 rounded"
									>{% url 'redaction:redaction_create' document.pk %}</code
								>
							</li>
							<li>Use DataStar to update the redactions list dynamically</li>
						</ol>
					</div>
				</div> -->
			</div>
		</div>

		<!-- Action Buttons -->
		<div class="mt-4">
			<a
				href="{% url 'redaction:document_download' document.pk %}"
				class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition-colors"
			>
				üì• Download Redacted PDF
			</a>
		</div>
	</div>

	<!-- Right Panel: Redactions List -->
	<div class="w-full lg:w-80 bg-white rounded-lg shadow-md p-6">
		<h3 class="text-lg font-bold text-gray-800 mb-4">Redactions</h3>

		<div class="text-sm text-gray-600 mb-4">
			<p>Total: <span class="font-semibold">{{ redactions.count }}</span></p>
		</div>
		{% include "redaction/redaction_list.html" %}
	</div>
</div>

<!-- Help Section -->
<div class="mt-6 bg-purple-50 border border-purple-200 rounded-lg p-4">
	<h4 class="font-semibold text-purple-900 mb-2">
		üéØ Implementation Guidelines
	</h4>
	<div class="text-sm text-purple-800 space-y-2">
		<p><strong>DataStar Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a href="https://data-star.dev" target="_blank" class="underline"
					>DataStar Documentation</a
				>
			</li>
			<li>
				<a
					href="https://data-star.dev/examples"
					target="_blank"
					class="underline"
					>DataStar Examples</a
				>
			</li>
		</ul>
		<p class="mt-2"><strong>PDF.js Resources:</strong></p>
		<ul class="list-disc list-inside ml-4">
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/"
					target="_blank"
					class="underline"
					>PDF.js Documentation</a
				>
			</li>
			<li>
				<a
					href="https://mozilla.github.io/pdf.js/examples/"
					target="_blank"
					class="underline"
					>PDF.js Examples</a
				>
			</li>
		</ul>
	</div>
</div>
{% endblock %}
